\documentclass{article}

\usepackage{booktabs}
\usepackage{float}
\usepackage{comment}
\usepackage{graphicx} 
\usepackage{amsthm} 
\usepackage{amsfonts}
\usepackage{pdfpages} 
\usepackage{siunitx} 
\usepackage{mhchem}
\usepackage{subfloat}
\usepackage{fullpage}
\usepackage{array}
\usepackage[toc,page]{appendix}

\newcommand{\ecoli}{\textit{E. coli}}
\newcommand{\ecloni}{\textit{E. cloni 10g}} 
\newcommand{\bsub}{\textit{B. subtilis}} 
\newcommand{\pbad}{P$_{BAD}$} 
\newcommand{\plux}{P$_{LUX}$}
\newcommand{\etal}{\textit{et al.}} 
\newcommand{\invivo}{\textit{in vivo}}
\newcommand{\invitro}{\textit{in vitro}} 
\newcommand{\csix}{3OC6HSL}

\newcommand{\tred}[1]{\textcolor{red}{#1}}
\newcommand{\tgr}[1]{\textcolor{green}{#1}}

% Units
\DeclareSIUnit{\molar}{M} 
\newcommand{\ul}{\si{\micro\litre}} 
\newcommand{\um}{\si{\micro\metre}}
\newcommand{\ml}{\si{\milli\litre}} 
\newcommand{\nm}{\si{\nano\metre}} 
\newcommand{\ugml}{\si{\micro\gram\per\milli\litre}} 
\newcommand{\degC}{\si{\degreeCelsius}}

% Misc
\newcommand{\tenx}{\ensuremath{10\times}}
\newcommand{\fortyx}{\ensuremath{40\times}}
\newcommand{\sixtyx}{\ensuremath{60\times}}
\newcommand{\hundredx}{\ensuremath{100\times}}
\newcommand{\odsix}{\ensuremath{\textrm{OD}_{600}}}
\newcommand{\Pspo}{\ensuremath{\textrm{P}_{\textrm{\scriptsize SPO1-26}}}}

% Matrix/ vector shit
\let\oldhat\hat 
\renewcommand{\vec}[1]{\mathbf{#1}}
\renewcommand{\hat}[1]{\oldhat{\mathbf{#1}}}
\let\oldcaption\caption
%\renewcommand{\caption}[2][]{\oldcaption[#1]{\small\textbf{#1.} #2\normalsize}}
\renewcommand{\caption}[2][]{\oldcaption[#1]{\textbf{#1.} #2}}

\newcommand{\mat}{\mathbf} 
\newcommand{\invmat}[1]{\mat{#1}^{-1}}
\newcommand{\deltap}{\Delta \vec{p}} 
\newcommand{\deltaL}{\Delta \vec{L}}
\newcommand{\deltag}{\Delta g} 
\newcommand{\Iinv}{\mat{I}^{-1}}
\newcommand{\Minv}{\mat{M}^{-1}}
\newcommand{\crossmat}[1]{{\left[#1\right]}_{\times}}

\newtheorem{remark}{Remark} 
\newtheorem*{note}{Note} 

\begin{document} 

\title{Eigenmorphs? Rational design of pattern and morphology in eigenspace}
\author{Tim Rudge}
\maketitle

\section{Background maths}
\subsection{Eigenfunctions of the laplacian}
Eigenfunctions of the laplacian $\nabla^2$ satisfy
\begin{equation}
\nabla^2 v(\vec{x}) + k^2 v(\vec{x}) = 0
\end{equation}

\begin{equation}
\nabla^2 \vec{v_k}(\vec{x}) + k^2 \vec{v_k}(\vec{x}) = 0
\end{equation}

given some boundary condition, such as $v=0$ or $\hat{\vec{n}}\cdot\nabla v=0$
or $\hat{\vec{n}}\cdot\nabla \vec{v_k}=0$
at the boundary $\partial\Omega$ of the domain $\Omega$. There is a discrete
(infinite) set of functions $v_i(\vec{x})$, with eigenvalues $k_i$.  For a
1-dimentionsal domain with zero boundary conditions for example, the
eignfunctions are sine waves $sin(k\pi/L)$ where $L$ is the length of the domain
and $k \in {0,1,2,3...}$.

On other arbitrary domains we have to compute them numerically. You can see they
are waves because the equation says when $v>0$ the curvature $\nabla^2v<0$ and
vice versa.

\subsection{Eigenfunction expansion or projection}
They also have the nice property that they form a complete basis for the space
of differentiable functions that satisfy the boundary conditions. That means that
any pattern (gene expression, signal concentration, etc.) on a given domain
(colony, organism, etc.) can be represented as a series
\begin{equation}
f(\vec{x}) = \sum_{i} w_i v_i(\vec{x})
\end{equation}

The Fourier transform is a particular case of the eigenspectrum (for linear or
ractangular domain), and in general (for arbitrarily shaped domains) the
eigenspectrum gives the amount of each eigenfunction represented in a
particular pattern
\begin{equation}
w_i = \langle f, v_i \rangle = \int_{\Omega} \! f(\vec{x}) v_i(\vec{x}) \, d\vec{x}
\end{equation}

\subsection{Eigenvectors and discrete space}
For computation we represent patterns on a regular grid like an image. It turns
out convenient to string this out as a 1-dimensional vector of length $wh$
for an image of width $w$ and height $h$. The operator $\nabla^2$ is then a
$wh \times wh$ matrix $\mat{M}$ which has eigenvectors $\vec{v}_i$ such that $\mat{M}\vec{v}_i
= \lambda_i \vec{v}_i$. The eigenvectors are images strung out as
one-dimensional vectors. Note that now there are a finite number of eigenvectors
equal to $wh$, the number of grid points or pixels in the image.

The eigenspectrum is just a basis transformation from the grid basis, where each
value in the grid (image) is an element of the vector, to the basis of
eigenvectors. This is the natural frequency domain of the shape defined by the
boundary conditions. Lets call this the eigenspace.

In discrete space we can define a matrix of eigenvectors
$\mat{W}$ where each column is an eigenvector $\vec{v}_i$ such that
\begin{equation}
\vec{w} = \mat{W}\vec{g}
\end{equation}
is the eigenspace transform of the image $\vec{g}$, and
\begin{equation}
\vec{g} = \mat{W}^T\vec{w}
\end{equation}
is the inverse transform. This is because the eigenvectors form an orthonormal
basis for the space of images (patterns).

\section{Design of pattern in eigenspace}
This means we can compute the eigenspectrum of any pattern, for example one that
we might want to design a genetic system to produce. Alternatively we could
design the spectrum of shape that we require from our genetic system. It would
be easy (relatively) to make a tool that allows you to adjust a curve and see
the resulting pattern (in Matlab for example). This curve could be a polynomial
for example. It seems reasonable that a useful biological pattern should be
localised in eigenspace (frequency space). If all wavelengths are represented
equally we have white noise, which possibly is maximal entropy. 

What we would like to do is choose a pattern and infer a genetic mechanism
coupled to signalling that could generate it. These genetic components would
come from a registry of characterised parts. For theoretical work we show the
principle for example by randomly generating part parameters to make a library.

\section{Reacion diffusion systems}
In this sense any patterning system can be seen as selecting (weighting)
some eigenvectors more than others. Reaction-diffusion systems are an obvious
example (there are others, see Murray). 
\begin{eqnarray}
u_t &=& \nabla^2u + \gamma f(u,v) \\
v_t &=& d \nabla^2v + \gamma g(u,v)
\end{eqnarray}

That is for two species (chemicals, genes etc.). More generally we write a
vector of species,

\begin{equation}
\vec{u}_t = \mat{D}\nabla^2\vec{u} + \gamma \vec{f}(\vec{u})
\end{equation}

In general we can't predict the final pattern
without solving numerically, but close to an equilibrium (homogeneous or
heterogeneous) we can approximate the reaction term as linear in the
perturbation $\vec{w} = (u-u_0,v-v_0)^T$ where $(u_0,v_0)$ is the equilibrium
giving
\begin{equation}
\vec{w}_t = \mat{D}\nabla^2\vec{w} + \mat{A}\vec{w}
\end{equation}
where $\mat{A}$ is the Jacobian
\begin{equation}
\mat{A}=
 \left[
  \begin{array}{ c c }
     f_u & f_v \\
     g_u & g_v
  \end{array} \right]
\end{equation}

We can use this to do a linear stability analysis and test for patterning. The
definition of a Turing system is that it has an unstable homogeneous
equilibrium, and a stable heterogeneous equilibrium. Around the homogeneous
equilibrium the behaviour can be approximated by the equation above. This is a
linear equation and so the solutions can be expanded in eigenvectors to get
\begin{equation}
\vec{w} = \sum_{k} c_k \vec{v}_k e^{\lambda(k^2) t}
\end{equation}
where the sum is over the discrete eigenvalue/vector pairs, 
and $\lambda(k^2)$ is called the \textit{dispersion relation} that tells us how
each eigenvector (wave) grows in time. If $\lambda(k^2)>0$ the wave grows, and
this part of the perturbation is propagated. This is how the system effectively
selects eigenvectors.

For a two-component reaction-diffusion system as above it can be shown (Murray)
that the dispersion relation $\lambda(k^2)$ is a quadratic in $k^2$. This means it
has a single peak and a range $k^2_{min}<k^2<k^2_{max}$ for which $\lambda>0$.
(Note the use of $k^2$ is because the sign of the spatial eigenvalue $k$ is
irrelevant, bit tedious to explain this but it comes out in the expansion above
when you compute the weights $c_k$).

Three things to note:
\begin{enumerate}
\item For a \textit{linear} reaction-diffusion system (not at all realistic
but useful to study) we can solve \textit{exactly} the evolution of the system
(eigenspace expansion above).
\item In general (non-linear systems) the only way to get the final eigenspectrum 
of a patterning system is to compute the solution numerically.
\item BUT, if we start from this equilibrium we \textit{can} compute the
evolution of \textit{small} perturbations from the eigenspace expansion above.
The spectrum says which waves grow.
\end{enumerate}

This last point will be very useful when we consider growing domains below.

\section{Growing domains}
We want to think about patterns in growing populations of cells such as
bacterial colonies or biofilms. Equally this could be plant or animal cells. The
pattern is then formed on a domain $\Omega(t)$ that evolves in time. Lets define
the shape with a level set $\phi(\vec{x},t)$ which is such that
$\phi(\vec{x},t)=0$ at the boundary $\partial \Omega(t)$.  Ideally we then want
to compute the time varying eigenfunctions $v_i(\vec{x},t)$ and eigenvalues
$k_i^2(t)$ of this growing domain.  This tells us how the pattern evolves in
time. Its not clear if this is possible so we'll just compute them numerically
at discrete time steps. But anyway useful to keep in mind.

\subsection{Speed does not vary in time}
If the domain grows outwards perpendicular to its boundary at some speed
$F(\vec{x})>0$ then the domain generated from some initial $\phi(\vec{x},t=0)$
can be found from the Eikonal equation (see Sethian paper),

\begin{equation}
\left| \nabla T \right| = \frac{1}{F}
\end{equation}

where $T(\vec{x})$ is the time at which the boundary crosses the point
$\vec{x}$, and the gradient is with boundary conditions $T=0$ at the 
 boundary defined by $\phi(\vec{x},0)=0$.
That is, points inside the domain $\Omega(t)$ are where
$T(\vec{x})\le t$ at all times $t$.


\subsection{Speed varying in time}
More generally solve the equation

\begin{equation}
\frac{\partial \phi}{\partial t} = F(\vec{x},t)\left|\nabla\phi(\vec{x})\right|
\end{equation}

A simple approach is to take a small time step and say that the speed is
approximately constant during this time. Then we solve at each time step $t$

\begin{equation}
\phi(t+\Delta t) = \phi(t) + F(\vec{x},t) \left|\nabla\phi(\vec{x})\right| \Delta t 
\end{equation}

with some discretisation of $\nabla$, given appropriate boundary conditions.

\subsection{Speed outside the domain}
For our model we want the speed to be determined by some patterning system,
genetics, signals etc. which are only defined on the domain (colony). We can't
say that the speed is zero outside the domain because then it doesn't grow. This
is an issue with the approach of tracking an interface between two things
(phases). A simple solution, given zero-flux boundary conditions so that the
speed is not changing at the boundary, is to extrapolate the speed outwards into
the background.

I approximated this in matlab by finding the closest boundary point for every
background pixel. I then set the speed at each background point 
to the closest boundary pixel's speed.

\subsection{Discretisation of pattern into a matrix sequence}
If we discretise time we can define a matrix at each time step that computes the
laplacian with given boundary conditions. These boundary conditions are applied
at pixels where $T(\vec{x})<t$, or $\phi(\vec{x},t)<0$, with $t \in \Delta
t\{0,1,2\dots\}$. If the matrix at each time step $t=j\Delta t$ is $\mat{M}(t)$
then we want to solve the eigensystem

\begin{equation}
\mat{M}(t) \vec{v}(t) + k^2 \vec{v}(t) = 0
\end{equation}

So our pattern at time step $t=j\Delta t$ is a weighted linear combination of
these vectors as described above.
Since these matrices act on images (strung out as vectors) of the same size, we
can write

\begin{equation}
\mat{M}(t+\Delta t) = \mat{M}(t) + \Delta\mat{M}(t)
\end{equation}

The difference between matrices at subsequent time steps $\Delta\mat{M}$ is
due to the change in domain boundary location. The matrix applies a laplacian
kernel at each pixel, a weighted sum of the pixel itself and its 4 neightbours.
The weights of neighbours are either 1 or 2 depending if at the boundary.
This means that when the domain changes some pixels which were weighted as a 1
become weighted as 2, and vice versa. So this is a very sparse matrix with only
non-zero elements at rows corresponding to boundary pixels for the previous and
new boundaries.

This is something to think more about. Can we get some information about changes
in the eigenvectors/values from the structure of $\Delta\mat{M}$?

\begin{comment}
We can also just directly think about a time varying matrix, eigenvector and
eigenvalue $\mat{A}(t)v(t) = k(t)^2 v(t)$. And 

\begin{equation}
(\mat{A}(t) + k(t)^2\mat{I}) v(t) = 0
\end{equation}

differentiate both sides

\begin{equation}
\left( \frac{\partial\mat{A}}{\partial t} + 2k\frac{\partial k}{\partial t}
\mat{I} \right) v 
+
(\mat{A}(t) + k(t)^2\mat{I}) \frac{\partial v}{\partial t}
\end{equation}

\end{comment}

\section{Coupling morphology to pattern}
Now it gets more interesting. The speed function $F(\vec{x},t)$ is
a pattern on our growing domain, colony biofilm etc. So we could decompose it into
eigenvectors. But it seems to me that the rate of motion is going to be a
complicated non-linear function of some underlying pattern of gene expression.

\begin{equation}
F(\vec{x},t) = F(\vec{u}(\vec{x},t))
\end{equation}

where $\vec{u}(\vec{x},t)$ is a vector of gene expression levels. In general
then this is generated by some patterning system that selects eigenfunctions as
discussed above. 

Now we have the coupled systems

\begin{equation}
\phi(t+\Delta t) = \phi(t) + F(\vec{u}(t)) \left|\nabla\phi(t)\right| \Delta t 
%\frac{\partial \phi}{\partial t} = F(u(\vec{x},t))\left|\nabla\phi(\vec{x})\right|
\end{equation}

and the eigensystem

\begin{equation}
\mat{M}(t) \vec{v}(t) + k^2 \vec{v}(t) = 0
\end{equation}

where at discrete time-step $t=j\Delta t$, $\mat{M}(t)$ encodes the laplacian
with boundary given by $\phi(\vec{x},t)=0$, and the pattern $\vec{u}(t)$ is a
weighted sum of its eigenvectors

\begin{equation}
\vec{u}(t+\Delta t) = \sum_{k} c_k(t+\Delta t) \vec{v}_k(t+\Delta t) e^{\lambda(k^2) \Delta t}
\end{equation}

and for our time-step $t=j\Delta t$ the weights $c_k$ are the projection of
the previous pattern $\vec{u}$ into the new set of eigenvectors,

\begin{equation}
c_k(t+\Delta t) = \langle \vec{u}(t), \vec{v}_k(t+\Delta t) \rangle =
\vec{u}(t) \cdot \vec{v}_k(t+\Delta t)
\end{equation}

\section{Algorithm}
Copy analysis of CellModeller here.

\section{Notes for Carlos and Rafael}
We are able to reasonably design transcription networks with a handful of nodes.
These networks can output visible fluorescent reporters accessible to
experiments, and enzymes that produce diffusible signals. In practice these
signals diffuse at similar rates. Other types of signalling might be possible

\begin{comment}
\section{Morphology in eigenspace?}

\section{Appearance of cells as transitions through eigenfunctions as stable
modes}
Conceptually cells in a tissue are periodic structures, and so can be described
using the approach above. You could think of the distribution of any molecular
constituent of a cell as a pattern, and that pattern is described by a linear
combination of eigenfunctions or waves. More abstractly one could think of a
pattern that is the probability distribution for something. This could for
example be the probability of observing the nucleus, that is the unit of
identity for that organism. Or why not the distribution of a gene? Or of an
epigenetic state/switch? Those patterns then are actually what we use to define
a cell.

A function/pattern satisfying given boundary conditions, and subject to
integrating to unity, is a wave function. This is analagous to quantum mechanics
and Schroedinger's equation. 
\end{comment}

\section{}
\end{document}

